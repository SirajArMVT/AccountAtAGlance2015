var dataService=new function(){var e="/api/dataService/",t=function(t){return $.getJSON(e+"account",{acctNumber:t})},o=function(){return $.getJSON(e+"marketIndices")},i=function(t){return $.getJSON(e+"quote",{symbol:t})},a=function(){return $.getJSON(e+"tickerQuotes")};return{getAccount:t,getMarketIndexes:o,getQuote:i,getTickerQuotes:a}};Handlebars.registerHelper("getChangeCSSClass",function(e){var t=parseFloat(e);return t>0?"Positive":"Negative"}),Handlebars.registerHelper("addPlus",function(e){var t=parseFloat(e);return t>0?"+":""}),Handlebars.registerHelper("addPlusMinus",function(e){var t=parseFloat(e);return t>0?"+":"-"});var sceneLayoutService=function(){var e,t=function(){e=$("#content").width();var t=6,o=210,i=93,a=93,r=264,n=197,l=365,s=270,d=340,c=584,u={tiles:[{name:"Account Details",tileId:"AccountDetails",formatter:tileFormatter.formatAccountDetails,scenes:[{height:n,width:l,top:0,left:0,opacity:1,size:1,borderColor:"#5E1B6B",z:0},{height:90,width:210,top:80,left:250,size:0,borderColor:"#5E1B6B",z:"2000",opacity:.5}]},{name:"Video",tileId:"Video",formatter:tileFormatter.formatVideo,scenes:[{height:n,width:s,top:0,left:l+t,opacity:1,size:1,borderColor:"#EF7632",z:0},{height:200,width:280,top:0,left:500,size:1,borderColor:"#EF7632",z:"10000",opacity:1}]},{name:"DOW",tileId:"DOW",formatter:tileFormatter.formatMarketData,chartColor:"green",scenes:[{height:i,width:r,top:0,left:l+s+2*t,opacity:1,size:0,borderColor:"#CE0810",z:0},{height:90,width:200,top:60,left:870,size:0,borderColor:"#CE0810",opacity:.7}]},{name:"NASDAQ",tileId:"NASDAQ",formatter:tileFormatter.formatMarketData,chartColor:"red",scenes:[{height:a,width:r,top:i+1.8*t,left:l+s+2*t,opacity:1,size:0,borderColor:"#CE0810",z:0},{height:105,width:250,top:200,left:0,size:0,borderColor:"#CE0810",opacity:.65,z:"2000"}]},{name:"SP500",tileId:"SP500",formatter:tileFormatter.formatMarketData,chartColor:null,scenes:[{height:i,width:r,top:0,left:l+s+r+3*t,opacity:1,size:0,borderColor:"#CE0810",z:0},{height:100,width:260,top:430,left:525,size:0,opacity:.45,z:"1000",borderColor:"#00324B"}]},{name:"Sector Summary",tileId:"SectorSummary",scenes:[{height:a,width:r,top:i+1.8*t,left:l+s+r+3*t,opacity:1,size:0,borderColor:"#00A600",z:0},{height:155,width:280,top:220,left:620,size:0,borderColor:"#00A600",opacity:.65}]},{name:"Market News",tileId:"MarketNews",scenes:[{height:n,width:l,top:0,left:l+s+2*r+4*t,opacity:1,size:1,borderColor:"#3749A9",z:0},{height:225,width:350,top:270,left:850,size:0,borderColor:"#3749A9",opacity:.9}]},{name:"Currencies",tileId:"Currencies",scenes:[{height:n,width:s,top:0,left:2*l+s+2*r+5*t,opacity:1,size:1,borderColor:"#00F277",z:0},{height:140,width:220,top:370,left:115,size:0,borderColor:"#00F277",opacity:.35}]},{name:"Quotes",tileId:"Quote",formatter:tileFormatter.formatQuote,scenes:[{height:d,width:c,top:o,left:0,opacity:1,size:2,borderColor:"#00324B",z:0},{height:205,width:270,top:240,left:305,size:1,borderColor:"#CE0810",opacity:.85,z:"5000"}]},{name:"Account Positions",tileId:"AccountPositions",formatter:tileFormatter.formatAccountPositions,scenes:[{height:d,width:c,top:o,left:592,opacity:1,size:2,borderColor:"#5DBBC0",z:0},{height:90,width:195,top:40,left:58,size:0,borderColor:"#5DBBC0",opacity:.2,z:"100"}]}]};return u};return{get:t}}(),sceneStateManager=function(){var e,t,o=1,i=760,a=!0,r=function(o){e=o;var i=sceneLayoutService.get();t=i.tiles,n(),tileBinder.loadTemplate("QuoteDataTemplate"),l(),d(),s()},n=function(){$(window).focus(function(){a=!0}),$(window).blur(function(){a=!1}),$("#left").click(C),$("#right").click(g),$("#gridButton").click(function(){b()}),$("#cloudButton").click(function(){b()})},l=function(){$(t).each(function(e){var t=$("<div/>",{"class":"tile",text:this.name,id:this.tileId});t.css("border-top","5px solid "+this.scenes[o].borderColor),t.data(this),y(t,this.scenes[o]),t.appendTo("#content"),8>e&&t.addClass("top-row"),t.draggable({opacity:.9,zIndex:5e3,revert:"invalid",revertDuration:500}),t.droppable({tolerance:"pointer",drop:function(e,t){v(t.draggable,$(this))}})})},s=function(){setTimeout(function(){dataService.getTickerQuotes().done(m),$("#aaglogo").delay("500").fadeIn("slow"),$(".tile").each(function(){$(this).fadeIn(360,"easeInCubic",function(){"Quote"==$(this).attr("id")&&$("#QuoteButton").click()})})},1e3),setInterval(function(){a&&dataService.getMarketIndexes().done(u)},15e3);var e=setInterval(function(){void 0!=$("#AccountDetails").data().templates&&void 0!=$("#AccountPositions").data().templates&&(clearInterval(e),b(),$(".scroller").delay(1e3).each(function(){$(this).fadeIn("slow","easeInCubic")}))},2e3)},d=function(){dataService.getAccount(e).done(c),dataService.getMarketIndexes().done(u),p()},c=function(e){$('div.tile[id^="Account"]').each(function(){h(e,$(this),0)})},u=function(e){h(e,$("#DOW"),0),h(e,$("#NASDAQ"),0),h(e,$("#SP500"),0)},h=function(e,t,o){return o>0&&t.fadeOut(o),o>0?void f(e,t,o):void tileBinder.bind(t,e,tileRenderer.render)},f=function(e,t,o){t.fadeIn(o,function(){tileBinder.bind(t,e,tileRenderer.render)})},p=function(){$("#Video, #Quote, #SectorSummary, #MarketNews, #Currencies").each(function(){if(null==$(this).data().templates){var e=$(this);tileBinder.bind(e,null,tileRenderer.render)}})},u=function(e){h(e,$("#DOW"),1200),h(e,$("#NASDAQ"),800),h(e,$("#SP500"),500)},c=function(e){$('div.tile[id^="Account"]').each(function(){h(e,$(this),500)})},m=function(e){$("#content").delay("800").fadeIn("slow"),$("#ticker").delay("2360").fadeIn("slow","easeInCubic",function(){$("#MarqueeNewsText").append(tileBinder.tmpl("TickerTemplate_News",e)),$("#MarqueeQuotesText").append(tileBinder.tmpl("TickerTemplate_Quotes",e));var t={velocity:50,direction:"horizontal",startfrom:"right",loop:"infinite",movetype:"linear",onmouseover:"play",onmouseout:"play",onstartup:"play",cursor:"pointer"};$("#MarqueeNews").SetScroller(t),$("#MarqueeQuotes").SetScroller(t)})},v=function(e,t){var i=e.data().scenes[o],a=t.data().scenes[o];if(y(t,i),y(e,a),w(i,a),0==o){var r=e.hasClass("top-row"),n=t.hasClass("top-row");r&&!n?(e.removeClass("top-row"),t.addClass("top-row")):!r&&n&&(t.removeClass("top-row"),e.addClass("top-row"))}var l=i.size,s=a.size;l!=s&&(t.data().scenes[o].size=l,e.data().scenes[o].size=s,tileRenderer.render(t),tileRenderer.render(e))},g=function(){$(".top-row").animate({left:"-=250px"},800,function(){$(this).data().scenes[o].left-=250})},C=function(){$(".top-row").animate({left:"+=250px"},800,function(){$(this).data().scenes[o].left+=250})},b=function(){0==o?(o=1,$(".scroller").hide(),$("#gridButton").delay(Math.floor(450*Math.random())).attr("disabled",!1).addClass("enabled"),$("#cloudButton").delay(Math.floor(450*Math.random())).attr("disabled",!0).removeClass("enabled")):1==o&&(o=0,$(".scroller").show(),$("#cloudButton").attr("disabled",!1).addClass("enabled"),$("#gridButton").attr("disabled",!0).removeClass("enabled")),$(".tile").each(function(){var e=$(this);y(e,e.data().scenes[o]),tileRenderer.render(e,o)})},y=function(e,t){e.animate({opacity:t.opacity,top:t.top,left:t.left,height:t.height,width:t.width,zIndex:t.z},{duration:i,easing:"easeInOutExpo",step:function(){},complete:function(){}})},w=function(e,t){var o=e.top,i=e.left,a=e.height,r=e.width,n=e.opacity,l=e.zindex;e.top=t.top,e.left=t.left,e.height=t.height,e.width=t.width,e.opacity=t.opacity,e.zindex=t.zindex,t.top=o,t.left=i,t.height=a,t.width=r,t.opacity=n,t.zindex=l};return{init:r,changeScene:b,getTiles:function(){return t},renderTiles:d,renderAccountTiles:c,renderMarketTiles:u,renderTile:h}}(),tileBinder=function(){var e="/Templates/",t=function(e,t,a){var r=e.attr("id")+"Template";o(r,function(o){var n=[i(r+"_Small",t),i(r+"_Medium",t),i(r+"_Large",t)];e.data().templates=n,e.data().tileData=t,a(e)})},o=function(t,o){$.get(e+t+".html",function(e){$("body").append(e);var i=t+"_Partial",a=$("#"+i);a.length&&Handlebars.registerPartial(i,a.html()),void 0!=o&&o(e)})},i=function(e,t){var o=$("#"+e).html();if(null!=t){var i=Handlebars.compile(o);return i(t)}return o};return{bind:t,loadTemplate:o,tmpl:i}}(),tileFormatter=new function(){var e=null,t=Raphael.ninja(),o=function(e){if(Modernizr.video){var t=e.data().scenes[0],o=$("#VideoPlayer"),i=2.43,a=Math.round(.75*t.height),r=Math.round(a*i);r>t.width&&(r=t.width-20),o.css({height:a+"px",width:r+"px"}),o.bind("click mousedown mouseup mousemove mouseenter mouseleave",function(e){e.stopPropagation()})}},i=function(){var e=$("#QuoteButton"),t=$("#QuoteTextBox"),o=$("#Quote"),i=o.data().symbol;t.val(null!=i?i:"msft");var a=function(){var e=t.val();""!=e&&dataService.getQuote(e).done(tileFormatter.formatQuoteData),o.data().symbol=t.val()};e.click(function(){a()}),t.keyup(function(e){13==e.keyCode&&a()}),e.is(":visible")&&e.trigger("click")},a=function(e){var t=["Small","Medium","Large"],o=$("#Quote"),i=$("#QuoteDataContainer");i.html("");var a=tileBinder.tmpl("QuoteDataTemplate_"+t[o.data().scenes[0].size],e);if(i.append(a),Modernizr.canvas){var r=$("#QuoteCanvas");if(r.length>0){r.html("");var l=.95*o.data().scenes[0].width,s=.52*o.data().scenes[0].height;n(r,l,s,"#6699FF",e,e.DataPoints)}}o.find(".Currency").formatCurrency({symbol:""})},r=function(e){var t=e.attr("id");if(Modernizr.canvas){var o=$("#"+t+"Canvas");if(o.length>0){o.html("");var i=e.data().scenes[0].size,a=1==i?.55:.72,r=.94*e.data().scenes[0].width,l=e.data().scenes[0].height*a,s=e.data().tileData;n(o,r,l,e.data().chartColor,s[t],s[t+"DataPoints"])}}e.find(".Currency").formatCurrency({symbol:""}),$("div.MarketQuoteLast").formatCurrency({symbol:""})},n=function(t,o,i,a,r,n){if(null!=n&&n.length>0){var s=[];for(var d in n){var c=n[d];s.push([c.JSTicks,c.Value])}var u=r.Last+.3*r.Last,h={series:{lines:{show:!0,fill:!0},points:{show:!0,radius:5}},grid:{hoverable:!0,autoHighlight:!0},legend:{position:"se"},yaxis:{max:u,min:0},xaxis:{minTickSize:[1,"hour"],mode:"time",timeformat:"%h %P",twelveHourClock:!0}};t.attr("style","width:"+o+"px;height:"+i+"px;"),$.plot(t,[{color:a,shadowSize:4,label:"Simulated Data",data:s}],h),t.bind("plothover",function(t,o,i){if(i){if(e!=i.datapoint){e=i.datapoint,$("#CanvasTooltip").remove();var a=i.datapoint[1].toFixed(2);l(i.pageX,i.pageY,a)}}else $("#CanvasTooltip").remove(),e=null})}},l=function(e,t,o){$('<div id="CanvasTooltip">'+o+"</div>").css({position:"absolute",display:"none",top:t+5,left:e+15,border:"1px solid #000",padding:"2px","background-color":"#fee",opacity:.8}).appendTo("body").fadeIn(200)},s=function(e){e.find(".Currency").formatCurrency();var o=e.data().scenes[0];if(Modernizr.inlinesvg&&$("#AccountPositionsSVG").length>0){var i=[],a=[];$(e.data().tileData.Positions).each(function(){a.push(this.Security.Symbol+"\r\n"+this.Shares+" shares"),i.push(this.Shares)}),t("AccountPositionsSVG",500,420).pieChart(o.width/2,o.height/4+10,66,i,a,"#fff")}},d=function(e){e.find(".Currency").formatCurrency({roundToDecimalPlace:0});var t=$("#"+e.attr("id")+"Table");t.length>0&&t.dataTable({bPaginate:!1,bLengthChange:!1,bFilter:!1,bInfo:!1,bRetrieve:!0,aoColumns:[null,null,null,null,null,null,{sType:"currency"}]})};return{formatVideo:o,formatAccountDetails:s,formatAccountPositions:d,formatQuote:i,formatQuoteData:a,formatMarketData:r}},tileRenderer=function(){var e=function(e,t){null==t&&(t=0);var o=e.data().scenes[t].size,i=e.data().templates[o],a=e.data().formatter;e.html(i),null!=a&&a(e)};return{render:e}}();